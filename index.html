<script type="importmap">
{
  "imports": {
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "html5-qrcode": "https://aistudiocdn.com/html5-qrcode@^2.3.8"
  }
}
</script>

<?php
/**
 * Plugin Name:       School Management System - QR Attendance
 * Description:       A seamless QR code attendance solution for PM SHRI Schools, fully integrated with the School Management System plugin by Mojoomla.
 * Version:           2.0.7
 * Author:            AI Assistant
 * License:           GPL-2.0-or-later
 * License URI:       https://www.gnu.org/licenses/gpl-2.0.html
 * Text Domain:       smgt-qr-attendance
 */

if ( ! defined( 'ABSPATH' ) ) exit;

add_action( 'plugins_loaded', 'smgt_qr_attendance_init' );

function smgt_qr_attendance_init() {
    $dependency_plugin = 'school-management/school-management.php';

    if ( ! function_exists( 'is_plugin_active' ) ) {
        include_once( ABSPATH . 'wp-admin/includes/plugin.php' );
    }

    if ( ! is_plugin_active( $dependency_plugin ) ) {
        add_action( 'admin_notices', 'smgt_qr_attendance_dependency_notice' );
        return;
    }

    smgt_qr_attendance_load_features();
}

function smgt_qr_attendance_dependency_notice() {
    ?>
    <div class="notice notice-error is-dismissible">
        <p>
            <?php
            echo wp_kses_post(
                sprintf(
                    __( 'The <strong>%1$s</strong> plugin is inactive. It requires the <strong>%2$s</strong> plugin to be installed and activated. Please activate the required plugin to use the QR attendance features.', 'smgt-qr-attendance' ),
                    'School Management System - QR Attendance',
                    'School Management System (by Mojoomla)'
                )
            );
            ?>
        </p>
    </div>
    <?php
}

function smgt_qr_attendance_load_features() {
    add_action( 'admin_menu', 'smgt_qr_add_admin_menu_pages', 99 );
    add_action( 'admin_enqueue_scripts', 'smgt_qr_enqueue_scanner_scripts' );
    add_action( 'rest_api_init', 'smgt_qr_register_rest_api' );
    add_action( 'edit_user_profile', 'smgt_qr_display_id_card_section' );
    add_action( 'show_user_profile', 'smgt_qr_display_id_card_section' );
    add_action('admin_init', 'smgt_qr_handle_download_trigger');
}

function smgt_qr_handle_download_trigger() {
    if (isset($_GET['page']) && $_GET['page'] === 'smgt-bulk-print-ids' && isset($_GET['download_source'])) {
        if ( ! isset( $_GET['_wpnonce'] ) || ! wp_verify_nonce( sanitize_key($_GET['_wpnonce']), 'download_plugin_source' ) ) {
            wp_die('Security check failed!');
        }
        if ( ! current_user_can('manage_options') ) {
            wp_die('You do not have permission to do this.');
        }
        smgt_qr_zip_and_download_plugin();
    }
}

function smgt_qr_zip_and_download_plugin() {
    $plugin_slug = basename(__DIR__);
    $plugin_dir = plugin_dir_path(__FILE__);
    $zip_file_name = $plugin_slug . '.zip';
    $zip_file_path = sys_get_temp_dir() . '/' . $zip_file_name;

    if (class_exists('ZipArchive')) {
        $zip = new ZipArchive();
        if ($zip->open($zip_file_path, ZipArchive::CREATE | ZipArchive::OVERWRITE) !== TRUE) {
            wp_die("Could not create ZIP archive.");
        }

        $files = new RecursiveIteratorIterator(
            new RecursiveDirectoryIterator($plugin_dir, RecursiveDirectoryIterator::SKIP_DOTS),
            RecursiveIteratorIterator::LEAVES_ONLY
        );
        
        $rootPath = realpath($plugin_dir);

        foreach ($files as $name => $file) {
            if (!$file->isDir()) {
                $filePath = $file->getRealPath();
                $relativePath = $plugin_slug . '/' . substr($filePath, strlen($rootPath) + 1);
                $zip->addFile($filePath, $relativePath);
            }
        }
        $zip->close();
    } else {
        wp_die("ZipArchive class not found. Please enable the Zip PHP extension.");
    }
    
    if (file_exists($zip_file_path)) {
        header('Content-Type: application/zip');
        header('Content-Disposition: attachment; filename="' . $zip_file_name . '"');
        header('Content-Length: ' . filesize($zip_file_path));
        header('Pragma: no-cache');
        header('Expires: 0');
        readfile($zip_file_path);
        unlink($zip_file_path); // Clean up the temp file
        exit;
    } else {
        wp_die("Could not create the zip file.");
    }
}


function smgt_qr_add_admin_menu_pages() {
    add_submenu_page( 'smgt_school', 'Scan Attendance', 'Scan Attendance', 'manage_options', 'smgt-scan-attendance', 'smgt_qr_scanner_page_render' );
    add_submenu_page( 'smgt_school', 'Bulk Print ID Cards', 'Bulk Print ID Cards', 'manage_options', 'smgt-bulk-print-ids', 'smgt_qr_bulk_print_page_render' );
}

function smgt_qr_scanner_page_render() {
    echo '<div class="wrap"><h1>Scan QR Code Attendance</h1><div id="smgt-qr-attendance-app"></div></div>';
}

function smgt_qr_enqueue_scanner_scripts( $hook ) {
    $current_screen = get_current_screen();
    
    $scanner_screen_id = 'smgt_school_page_smgt-scan-attendance';

    if ( !is_object($current_screen) || $current_screen->id !== $scanner_screen_id ) {
        return;
    }
    
    $script_url = plugins_url( 'index.tsx', __FILE__ );
    
    wp_enqueue_script( 'smgt-qr-attendance-app', $script_url, ['wp-element'], '2.0.7', true );
    wp_localize_script( 'smgt-qr-attendance-app', 'smgtQrAttendanceData', [
        'apiUrl'   => rest_url( 'smgt-qr-attendance/v1/log' ),
        'nonce'    => wp_create_nonce( 'wp_rest' ),
        'is_admin' => current_user_can( 'manage_options' ),
    ]);
}

function smgt_qr_register_rest_api() {
    register_rest_route( 'smgt-qr-attendance/v1', '/log', [
        'methods'  => 'POST',
        'callback' => 'smgt_qr_log_attendance_callback',
        'permission_callback' => fn() => current_user_can( 'edit_posts' )
    ]);
}

function smgt_qr_log_attendance_callback( WP_REST_Request $request ) {
    global $wpdb;
    $params = $request->get_json_params();
    $qr_data_string = sanitize_text_field( $params['qrData'] ?? '' );
    if ( empty($qr_data_string) ) return new WP_Error( 'bad_request', 'Missing QR data.', ['status' => 400] );
    
    $qr_data = json_decode( html_entity_decode( $qr_data_string ), true );
    if ( !is_array($qr_data) || !isset($qr_data['id']) ) return new WP_Error( 'invalid_qr', 'Invalid QR format.', ['status' => 400] );
    
    $user_id = absint( $qr_data['id'] );
    $user = get_userdata($user_id);
    if (!$user) return new WP_Error( 'user_not_found', "User with ID {$user_id} not found.", ['status' => 404] );

    $user_roles = $user->roles;
    $user_role = array_shift($user_roles);
    $current_date = date('Y-m-d');
    $attend_by = get_current_user_id();
    $result = false;

    if ($user_role == 'student') {
        $table = $wpdb->prefix . 'smgt_sub_attendance';
        $existing = $wpdb->get_var( $wpdb->prepare( "SELECT attendance_id FROM $table WHERE user_id = %d AND attendance_date = %s AND categories = 'class'", $user_id, $current_date ) );
        
        if ($existing) {
            return new WP_REST_Response( [ 'success' => true, 'message' => "Attendance for student {$user->display_name} already marked for today.", 'attendanceStatus' => 'Present' ], 200 );
        }

        $class_id = get_user_meta( $user_id, 'class_name', true );
        $section_id = get_user_meta( $user_id, 'class_section', true );

        $result = $wpdb->insert( $table, [
            'user_id' => $user_id, 
            'class_id' => $class_id ? absint($class_id) : 0, 
            'section_id' => $section_id ? absint($section_id) : 0,
            'attend_by' => $attend_by,
            'attendance_date' => $current_date,
            'status' => 'Present', 
            'role_name' => 'student',
            'categories' => 'class',
            'comment' => 'Marked via QR Scan'
        ]);
    } elseif ($user_role == 'teacher') {
        $table = $wpdb->prefix . 'attendence';
        $existing = $wpdb->get_var( $wpdb->prepare( "SELECT attendence_id FROM $table WHERE user_id = %d AND attendence_date = %s AND role_name = 'teacher'", $user_id, $current_date ) );

        if ($existing) {
            return new WP_REST_Response( [ 'success' => true, 'message' => "Attendance for teacher {$user->display_name} already marked for today.", 'attendanceStatus' => 'Present' ], 200 );
        }
        
        $result = $wpdb->insert( $table, [
            'user_id' => $user_id, 
            'class_id' => 0,
            'attend_by' => $attend_by,
            'attendence_date' => $current_date,
            'status' => 'Present', 
            'role_name' => 'teacher',
            'comment' => 'Marked via QR Scan'
        ]);
    } else {
        return new WP_Error( 'invalid_role', 'QR Scan is only for students and teachers.', ['status' => 400] );
    }

    if ( $result === false ) return new WP_Error( 'db_error', 'Could not save attendance.', ['status' => 500] );

    return new WP_REST_Response( [ 'success' => true, 'message' => "Attendance marked for {$user->display_name}.", 'attendanceStatus' => 'On Time' ], 200 );
}


function smgt_qr_display_id_card_section( $user ) {
    if ( !in_array('student', $user->roles) && !in_array('teacher', $user->roles) ) return;
    ?>
    <h3>QR Attendance ID Card</h3>
    <table class="form-table"><tr><th><label>ID Card</label></th><td>
    <?php smgt_qr_render_single_id_card($user); ?>
    <p class="description">Use the browser's print function (Ctrl/Cmd+P) to print this ID card.</p>
    </td></tr></table>
    <?php
}

function smgt_qr_bulk_print_page_render() {
    global $wpdb;
    ?>
    <div class="wrap">
        <h1>Bulk Print Student ID Cards</h1>

        <div style="margin-bottom: 20px; padding: 1px 15px; background-color: #fff; border: 1px solid #ddd; border-radius: 4px;">
            <h3>Plugin Management</h3>
            <p>Download the full source code for this plugin as a .zip file. This is useful for backups or manual installations.</p>
            <?php
            $download_nonce = wp_create_nonce('download_plugin_source');
            $download_url = admin_url('admin.php?page=smgt-bulk-print-ids&download_source=true&_wpnonce=' . $download_nonce);
            ?>
            <p><a href="<?php echo esc_url($download_url); ?>" class="button button-secondary">
                <span class="dashicons dashicons-download" style="vertical-align: text-bottom; margin-right: 5px;"></span>
                Download Plugin Source (.zip)
            </a></p>
        </div>

        <p>Select a class to generate printable ID cards for all students.</p>
        <form method="POST" class="smgt-qr-print-form">
            <?php
            $class_table = $wpdb->prefix . 'smgt_class';
            $classes = $wpdb->get_results("SELECT class_id, class_name FROM $class_table"); 
            ?>
            <label for="smgt_class_select">Select Class:</label>
            <select name="smgt_class_select" id="smgt_class_select">
                <option value="">-- Select a Class --</option>
                <?php foreach ($classes as $class) : ?>
                    <option value="<?php echo esc_attr($class->class_id); ?>" <?php selected(isset($_POST['smgt_class_select']) ? (int) $_POST['smgt_class_select'] : 0, $class->class_id); ?>>
                        <?php echo esc_html($class->class_name); ?>
                    </option>
                <?php endforeach; ?>
            </select>
            <input type="submit" name="generate_id_cards" class="button button-primary" value="Generate">
        </form>
        <hr/>
        <div class="smgt-qr-id-cards-container">
            <?php
            if ( isset($_POST['generate_id_cards']) && !empty($_POST['smgt_class_select']) ) {
                $selected_class_id = absint($_POST['smgt_class_select']);
                $class_name = $wpdb->get_var($wpdb->prepare("SELECT class_name FROM $class_table WHERE class_id=%d", $selected_class_id));
                echo "<h2>ID Cards for " . esc_html($class_name) . "</h2>";
                echo '<p>Use your browser\'s print function (Ctrl/Cmd + P) to print these cards.</p>';
                
                $students = get_users( ['role' => 'student', 'meta_key' => 'class_name', 'meta_value' => $selected_class_id] );
                
                if (empty($students)) {
                    echo '<p>No students found for this class.</p>';
                } else {
                    foreach ($students as $student) {
                        smgt_qr_render_single_id_card($student);
                    }
                }
            }
            ?>
        </div>
    </div>
    <?php
    smgt_qr_id_card_styles(); // Inject CSS
}

function smgt_qr_render_single_id_card( $user ) {
    $user_id = $user->ID;
    $qr_data_raw = ['id' => $user_id, 'name' => $user->display_name];
    $qr_data_filtered = apply_filters('smgt_qr_attendance_data', $qr_data_raw, $user_id);
    $qr_data = json_encode($qr_data_filtered);

    $qr_code_url = 'https://api.qrserver.com/v1/create-qr-code/?size=120x120&amp;data=' . urlencode($qr_data);
    $school_logo_url = 'https://ponsrischool.in/wp-content/uploads/2025/03/cropped-download.png';
    
    $dob = get_user_meta( $user_id, 'smgt_bdate', true ) ?: 'N/A';
    $mobile = get_user_meta( $user_id, 'mobile', true ) ?: 'N/A';
    $photo_url = get_user_meta( $user_id, 'smgt_user_avatar', true );
    if ( empty($photo_url) ) {
        $photo_url = get_avatar_url( $user_id, ['size' => 150] );
    }
    ?>
    <div class="smgt-id-card">
        <div class="id-card-header">
            <img src="<?php echo esc_url($school_logo_url); ?>" alt="School Logo">
            <span>PM SHRI PRATHMIK<br>VIDHYAMANDIR PONSRI</span>
        </div>
        <div class="id-card-body">
            <div class="id-card-photo">
                <img src="<?php echo esc_url( $photo_url ); ?>" alt="<?php echo esc_attr( $user->display_name ); ?>">
            </div>
            <div class="id-card-info">
                <div class="id-card-name"><?php echo esc_html( $user->display_name ); ?></div>
                <div class="id-card-details">
                    <strong>DOB:</strong> <?php echo esc_html( $dob ); ?><br>
                    <strong>Mobile:</strong> <?php echo esc_html( $mobile ); ?>
                </div>
            </div>
            <div class="id-card-qr">
                <img src="<?php echo esc_url($qr_code_url); ?>" alt="QR Code">
            </div>
        </div>
    </div>
    <?php
}

function smgt_qr_id_card_styles() {
    ?>
    <style type="text/css">
        .smgt-id-card {
            width: 320px;
            height: 200px;
            border: 1px solid #ccc;
            border-radius: 10px;
            font-family: sans-serif;
            display: inline-block;
            margin: 10px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            page-break-inside: avoid;
        }
        .id-card-header { 
            background-color: #3c8dbc; 
            color: white; 
            font-weight: bold; 
            padding: 8px 10px; 
            font-size: 10px; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            line-height: 1.2; 
            text-align: left;
        }
        .id-card-header img {
            height: 30px;
            width: 30px;
        }
        .id-card-header span {
            flex-grow: 1;
        }
        .id-card-body { display: flex; padding: 10px; align-items: center; }
        .id-card-photo { flex-shrink: 0; margin-right: 10px; }
        .id-card-photo img { width: 80px; height: 80px; border-radius: 5px; border: 2px solid #ddd; object-fit: cover; }
        .id-card-info { flex-grow: 1; }
        .id-card-name { font-size: 16px; font-weight: bold; color: #333; }
        .id-card-details { font-size: 12px; color: #555; margin-top: 5px; line-height: 1.4; }
        .id-card-qr { flex-shrink: 0; }
        .id-card-qr img { width: 80px; height: 80px; }

        @media print {
            body { background-color: white; }
            .smgt-qr-print-form, .wrap > h1, .wrap > p, .wrap > hr, .wrap > h2, .wrap > div[style*="margin-bottom"] { display: none; }
            .smgt-qr-id-cards-container { margin-top: 0; }
            #wpadminbar, #adminmenumain, #wpfooter { display: none !important; }
            #wpcontent { margin-left: 0 !important; padding-top: 0 !important; }
            .smgt-id-card { box-shadow: none; border: 1px solid #000; }
        }
    </style>
    <?php
}